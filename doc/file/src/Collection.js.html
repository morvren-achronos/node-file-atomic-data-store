<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">src/Collection.js | fs-atomic-data-store</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="key-record store, allows any data, uses filesystem, supports transactions"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="fs-atomic-data-store"><meta property="twitter:description" content="key-record store, allows any data, uses filesystem, supports transactions"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Collection.js~Collection.html">Collection</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Lock.js~Lock.html">Lock</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Record.js~Record.html">Record</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Store.js~Store.html">Store</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-LockInfo">LockInfo</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/Collection.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">/**
 * class Collection
 */

/**
 * Interact with a colection of records
 *
 * Do not instantiate this class directly, use methods from class {Store}
 *
 * @access public
 */
module.exports = class Collection {
	/**
	 * Get collection interaction instance
	 *
	 * @access public
	 * @param {Store} store - object
	 * @param {string} collection - collection name
	 */
	constructor(store, collection) {
		/**
		 * @access private
		 */
		this._store = store;
		/**
		 * @access private
		 */
		this._name = collection;
	}


	// Utility methods

	/**
	 * Store instance for this collection
	 *
	 * @type Store
	 */
	get store() {
		return this._store;
	}

	/**
	 * Collection name
	 *
	 * @type string
	 */
	get name() {
		return this._name;
	}

	/**
	 * Get directory path within collection
	 *
	 * Directory is created if it doesn&apos;t exist.
	 *
	 * @param {array} dirParts - dir path components
	 * @param {bool} create - true to create directory if it does not exist
	 * @returns {Promise&lt;string&gt;} dirpath
	 */
	async dir(dirParts = [], create = true) {
		return this.store.dir([this.store.option(&apos;recordsDir&apos;), this.name, ...dirParts], create);
	}


	// Factory methods

	/**
	 * Return an object to interact with a record within this collection
	 *
	 * @param {string} identifier - record identifier
	 * @returns {Record} object
	 */
	record(identifier) {
		return new (this.store.option(&apos;recordClass&apos;))(this.store, this, identifier);
	}


	// Data operation methods

	/**
	 * Iterate over all records in collection, calling function for each
	 *
	 * @param {function} callback - called for each record found
	 *   Signature: `function(identiier, recordIndex, collectionObj): {(void|bool}}`
	 *   If callback returns bool false, traversal is halted
	 * @returns {Promise&lt;number&gt;} total records traversed
	 */
	async traverse(callback) {
		const
			rootDir = await this.dir([], false),
			path = this.store.path,
			fs  = this.store.fs
		;
		function getDirectoriesInDir(dir) {
			return new Promise((resolve, reject) =&gt; {
				fs.readdir(
					dir,
					{
						withFileTypes: true
					},
					(err, entries) =&gt; {
						if (err) {
							if (err.code == &apos;ENOENT&apos;) {
								resolve([]);
							}
							reject(err);
							return;
						}
						let dirs = [];
						for (let ent of entries) {
							if (ent.isDirectory()) {
								dirs.push(ent.name);
							}
						}
						resolve(dirs);
					}
				);
			});
		}
		let stack = [
			[rootDir, await getDirectoriesInDir(rootDir)]
		];
		let recordCount = 0;
		while (stack.length) {
			let level = stack.length - 1;
			if (!stack[level][1].length) {
				stack.pop();
				continue;
			}
			let dir = path.join(stack[level][0], stack[level][1].pop());
			let subdirs = await getDirectoriesInDir(dir);
			if (!subdirs.length) {
				continue;
			}
			if (level &lt; 3) {
				stack.push([dir, subdirs]);
				continue;
			}
			for (let identifier of subdirs) {
				if (callback(identifier, recordCount++, this) === false) {
					stack = [];
					break;
				}
			}
		}
		return recordCount;
	}
};
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
